# Simple Server

[![Build Status](https://semaphoreci.com/api/v1/resolvetosavelives/simple-server/branches/master/badge.svg)](https://semaphoreci.com/resolvetosavelives/simple-server)

This is the backend for the Simple app to help track hypertensive patients across a population.

## Table of Contents

* [Development](#development)
* [Documentation](#documentation)
* [Deployment](#deployment)
* [Contributing](#contributing)

## Development

### Setup

To set up the Simple server for local development, clone the git repository and
run the setup script included.

```
$ git clone git@github.com:simpledotorg/simple-server.git
$ cd simple-server
$ bin/setup
```

#### Manual Setup

If the included `bin/setup` script fails for some reason, you can also manually
set up the application step by step. You can do so as follows.

First, you need to [install
ruby](https://www.ruby-lang.org/en/documentation/installation). It is
recommended to use [rbenv](https://github.com/rbenv/rbenv) to manage ruby
versions.

```bash
gem install bundler
bundle install
rake yarn:install
rails db:setup
```

#### Developing with the Android app

To run [simple-android](https://github.com/simpledotorg/simple-android/) app
with the server running locally, you can use [ngrok](https://ngrok.com).

```bash
brew cask install ngrok
rails server
ngrok http 3000
```

The output of the ngrok command will have an url that can be used to access
local-server. This url should be set as `qaApiEndpoint` in gradle.properties.

#### Workers

We use [sidekiq](https://github.com/mperham/sidekiq) to run async tasks. To run, first make sure that redis (>4) is installed:

```bash
brew install redis

# after installing ensure your redis version is >4
redis-server -v
```

### Testing Email

We use [Mailcatcher](https://mailcatcher.me/) for testing email in development. Please use the
following to set it up on your machine.

_Note: Please don't add Mailcatcher to the `Gemfile`, as it causes conflicts._

```bash
gem install mailcatcher
mailcatcher
```

Now you should be able to see test emails at http://localhost:1080

### Configuration

The app uses a base development configuration using `.env.development`. To add or override any configurations during
local development, create a `.env.development.local` file and add your necessary configurations there. If a
configuration change is applicable to all dev environments, ensure that it is added to `.env.development` and checked
into the codebase.

### Running the application locally

Foreman is used to run the application locally. First, install foreman.

```bash
$ gem install foreman
```

Then, run the following command to start the Rails and Sidekiq together.

```bash
$ foreman start -f Procfile.dev
```

**Note:** Foreman will also execute the `whenever` gem in trial mode. This will validate that the `whenever`
configuration is valid, but will not actually schedule any cron jobs.

Alternatively, you can start these services locally _without_ foreman by using the following commands individually.

* Rails: `bundle exec rails server` or `bundle exec puma`
* Sidekiq: `bundle exec sidekiq`

### Running the tests

```bash
RAILS_ENV=test bundle exec rspec
```

### Generating seed data

To generate seed data, execute the following command from the project root

```bash
$ foreman start -f Procfile.dev
$ bundle exec rails db:seed db:seed_users_data
```
**Note**: This **requires** server and sidekiq to be running.

To purge the generated patient data, run

```bash
bundle exec rails db:purge_users_data
```

**Note**: This only removes data created by `db:seed_users_data`, it keeps the seed data created by `db:seed`.

### Creating an admin user

Run the following command from the project root to create a new dashboard admin:
```bash
bundle exec rails 'create_admin_user[<name>,<email>,<password>]'
```

## Documentation

### API

API Documentation can be accessed at `/api-docs` on local server and hosted at https://api.simple.org/api-docs

To regenerate the Swagger API documentation, run the following command.

```
$ bundle exec rake rswag:specs:swaggerize
```

### ADRs

Architecture decisions are captured in ADR format and are available in `/doc/arch`

### ERD (Entity-Relationship Diagram)

These are not actively committed into the repository. But can be generated by running `bundle exec erd`


## Deployment

Simple Server is deployed to several environments using a mixture of tools.

* Ansible: Server management and configuration is done using Ansible. See the [deployment repository](https://github.com/simpledotorg/deployment/tree/master/ansible)
  for more information.
* Capistrano: Application code is deployed to servers for a specific country and environment using Capistrano.

Detailed deployment instructions for Simple Server can be found [here](doc/deployment.md).

> Make sure you add your SSH keys as single sign-on so that `cap` doesn't get confused when there's more than 1 instance
> to deal with. You can do this simply by running `ssh-add -K ~/.ssh/id_rsa`.

### Deployment to a specific environment

* We use Capistrano [multi-config](https://github.com/railsware/capistrano-multiconfig) to do multi-country deploys.
* All `cap` commands are namespaced with the country name. For eg: `bundle exec india:sandbox deploy`.
* The available country names are listed under `config/deploy`. The subsequent envs, under the country directory, like
  `config/deploy/india/sandbox.rb`

Simple Server can be deployed to a specific environment of a specific country with the following command.

```bash
bundle exec cap <country_name>:<enviroment> deploy
# eg: bundle exec cap india:staging deploy
# or, bundle exec cap bangladesh:production deploy
```

Rake tasks can be run on the deployed server using Capistrano as well. For example,

```bash
bundle exec cap india:staging deploy:rake task=db:seed
```

### Deployment Resources

* [Deployment instructions for Simple Server](doc/deployment.md)
* [Deployment repository](https://github.com/simpledotorg/deployment)

## Contributing

The contribution guidelines can be found [here](doc/contributing.md).
