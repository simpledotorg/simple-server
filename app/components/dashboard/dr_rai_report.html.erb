<div id="dr-rai--progress">
  <div class="actions-block">
    <div class="actions-header">
      <h4>Action plans</h4>
      <% quarterlies.each do |period, info| %>
        <%= link_to human_readable(period), "#{request.path}?#{request.query_parameters.merge(selected_quarter: period.value.to_s).to_param}", class: classes_for_period(period) %>
      <% end %>
      <% if current_period? %>
      <button class="actions-header-add-action" type="button" data-toggle="canvas" data-target="#dr-rai--sidebar" aria-expanded="false" aria-controls="dr-rai--sidebar">&#x2b; Add an action</button>
      <% end %>
    </div>

    <% if action_plans.present? %>
      <% action_plans.each do |action_plan| %>
        <div class="action-progress-block">
          <div class="progress-options">
            <button targetpopover="progress-options">
              <i class="fa-solid fa-ellipsis"></i>
            </button>
            <%# <div class="popover" popover="manual" id="progress-options"> %>
              <%#   <ul> %>
                <%#     <li class="edit">Edit</li> %>
                <%#     <hr /> %>
                <%#     <li class="delete">Delete</li> %>
                <%#   </ul> %>
              <%# </div> %>
          </div>
          <div>
            <h3><%= action_plan.statement %></h3>
            <% if !action_plan.actions.nil? %>
              <ul>
              <% action_plan.actions.lines.each do |line| %>
                <li>
                  <p><%= line %></p>
                </li>
              <% end %>
              </ul>
            <% end %>
          </div>
          <div class="progress-right-col">
            <p class="progress-statement"><%= action_plan.numerator %> of <%= action_plan.denominator %> overdue patients</p>
            <div class="progress-bar">
              <div class="progress-bar-fill" style="width: <%= action_plan.progress %>%">
                <span class="progress-number progress-number-over-88-percent"><%= action_plan.progress %>%</span>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="empty-goals-block">
        <% if current_period? %>
        <p class="empty-goals-message">
          Add an action for <%= start_of(selected_period) %> to <%= end_of(selected_period) %>
        </p>
        <button class="empty-goals-add-button" type="button" data-toggle="canvas" data-target="#dr-rai--sidebar" aria-expanded="false" aria-controls="dr-rai--sidebar">
          &#x2b; Add an action
        </button>
        <% else %>
        <p class="empty-goals-message">
          No actions for <%= start_of(selected_period) %> to <%= end_of(selected_period) %>
        </p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<div class="sidepanel bs-canvas bs-canvas-right position-fixed bg-light h-100" tabindex="-1" id="dr-rai--sidebar" data-period="<%= current_period.value %>" data-region="<%= region.slug %>">
  <div class="header">
    <p>Create action</p>
    <button class="bs-canvas-close float-left close" aria-label="Close">
      <i class="fa-solid fa-xmark-large"></i>
    </button>
  </div>
  <% if current_period? %>
  <div class="content">
    <h1><%= start_of(selected_period) %> - <%= end_of(selected_period) %> (<%= human_readable(selected_period) %>)</h1>
    <div class="step-block" id="step-1">
      <div class="active">
        <h2>Which indicator to improve?</h2>
        <button class="link-button edit">Edit</button>
        <ul>
        <% indicators.each do |indicator| %>
          <li><button class="link-button advancer" data-target-type="<%= indicator.target_type %>" data-target-ui="<%= indicator.target_type_frontend %>" data-indicator-id=<%= indicator.id %> data-indicator-denominator="<%= indicator_denominator(indicator) %>">Contact overdue patients</button></li>
        <% end %>
        </ul>
      </div>
      <div class='inactive d-none'>
        <p class="step-statement"></p>
      </div>
    </div>
    <div class="step-block d-none" id="step-2-percent">
      <div class='active'>
        <h2>What is the goal?</h2>
        <button class="link-button edit">Edit</button>
        <label class="goal-input-block">
          <input type="text" placeholder="Q2 goal">
          <span class="">%</span>
        </label>
        <p class="activity-promise d-none">Contact <span class="highlight target-number">500</span> overdue patients by <%= end_of(selected_period) %></p>
        <p class="activity-statement"><span>6%</span> overdue patients called (600 of 10,000) in <%= human_readable(selected_period.previous) %></p>
        <button class="next-button">Next</button>
      </div>
      <div class="inactive d-none">
        <p class="step-statement">Call 500 overdue patients by Jun 30</p>
      </div>
    </div>
    <div class="step-block d-none" id="step-2-numeric">
      <div class='active'>
        <h2>What is the goal?</h2>
        <button class="link-button edit">Edit</button>
        <label class="goal-input-block">
          <input type="text" placeholder="Q2 goal">
          <span class="">patients</span>
        </label>
        <p class="activity-promise d-none">Contact <span class="highlight target-number">500</span> overdue patients by <%= end_of(selected_period) %></p>
        <p class="activity-statement"><span>6%</span> overdue patients called (600 of 10,000) in <%= human_readable(selected_period.previous) %></p>
        <button class="next-button">Next</button>
      </div>
      <div class="inactive d-none">
        <p class="step-statement">Call 3600 overdue patients by Jun 30</p>
      </div>
    </div>
    <div class="step-block d-none" id="step-2-boolean">
      <div class='active'>
        <h2>What is the goal?</h2>
        <button class="link-button edit">Edit</button>
        <button class="next-button">Next</button>
      </div>
      <div class="inactive d-none">
        <p class="step-statement">Mark as done when completed</p>
      </div>
    </div>
    <div class="step-block d-none" id="step-3">
      <h2>What action should be taken?</h2>
      <textarea class="custom-actions-list" rows="4" placeholder="Write actions or select from list below..."></textarea>
      <p>Common actions:</p>
      <ul class="common-actions-list">
        <li><button class="link-button">Allocate staff time for calling patients</button></li>
        <li><button class="link-button">Train staff on SOP for calling overdue patients</button></li>
        <li><button class="link-button">Call 25 patients per day</button></li>
        <li classs="clicked"><button class="link-button ">Record call outcomes in Simple</button></li>
      </ul>
    </div>
    <div class="action-buttons-block">
      <button class="action-button cancel-button">Discard</button>
      <button class="action-button save-button invisible">Save</button>
    </div>
  </div>
  <% else %>
  <div class="content" %>
    <h1><%= start_of(selected_period) %> - <%= end_of(selected_period) %> (<%= human_readable(selected_period) %>)</h1>
    <p>Cannot create action plans for periods in the past</p>
  </div>
  <% end %>
</div>

<script type="text/javascript" charset="utf-8">
  jQuery(document).ready(function($) {
    var bsDefaults = { offset: false, overlay: true, width: '450px' },
        bsMain = $('.bs-offset-main'),
        bsOverlay = $('.bs-canvas-overlay')

    const toHide = [], toReveal = []

    // Opening the offcanvas
    $('[data-toggle="canvas"][aria-expanded="false"]').on('click', function() {
      var canvas = $(this).data('target'),
          opts = $.extend({}, bsDefaults, $(canvas).data()),
          prop = $(canvas).hasClass('bs-canvas-right') ? 'margin-right' : 'margin-left'

      if (opts.width === '100%') {
        opts.offset = false
      }

      $(canvas).css('width', opts.width)
      if (opts.offset && bsMain.length) {
        bsMain.css(prop, opts.width)
      }

      $(canvas + ' .bs-canvas-close').attr('aria-expanded', "true")
      $('[data-toggle="canvas"][data-target="' + canvas + '"]').attr('aria-expanded', "true")
      if (opts.overlay && bsOverlay.length)
        bsOverlay.addClass('show')
      return false
    })

    // Closing the offcanvas
    // NOTE: When wiring this up with data, consider adding the save button
    // here, or extracting this into a function so the save button can reuse its
    // logic.
    $('.bs-canvas-close, .bs-canvas-overlay').on('click', function() {
      var canvas, aria
      if ($(this).hasClass('bs-canvas-close')) {
        canvas = $(this).closest('.bs-canvas')
        aria = $(this).add($('[data-toggle="canvas"][data-target="#' + canvas.attr('id') + '"]'))
        if (bsMain.length) {
          bsMain.css(($(canvas).hasClass('bs-canvas-right') ? 'margin-right' : 'margin-left'), '')
        }
      } else {
        canvas = $('.bs-canvas')
        aria = $('.bs-canvas-close, [data-toggle="canvas"]')
        if (bsMain.length) {
          bsMain.css({
            'margin-left': '',
            'margin-right': ''
          })
        }
      }
      canvas.css('width', '')
      aria.attr('aria-expanded', "false")
      if (bsOverlay.length) {
        bsOverlay.removeClass('show')
      }
      return false
    })

    // ===================
    // BEGIN DR. RAI LOGIC
    // ===================

    // TODO: Handle state through "step-through"
    // Here, we should be answering the questions
    //   - What state do we want to pass along from the frontend to the back?
    //   - Do we want health workers to be able to recover from halfway through?
    $('.step-block').on('step-through', (e, nextUI, targetType, indicatorDenominator) => {
      const targets = ['.active', '.inactive']
      targets.forEach((target) => $(e.currentTarget).find(target).toggleClass('d-none'))
      $(e.currentTarget).find('.active').addClass('d-none')
      toReveal.push($(e.currentTarget).find('.active'))
      $(e.currentTarget).find('.inactive').removeClass('d-none')
      toHide.push($(e.currentTarget).find('.inactive'))
      const nextStep = parseInt(e.currentTarget.id.split('-')[1]) + 1
      if (nextUI === undefined) {
        $('#step-' + nextStep).removeClass('d-none')
        toHide.push($('#step-' + nextStep))
      } else {
        if (nextUI == 'percent') {
          $('#step-' + nextStep + '-' + nextUI).data('denominator', indicatorDenominator)
        }
        $('#step-' + nextStep + '-' + nextUI).removeClass('d-none')
        toHide.push($('#step-' + nextStep + '-' + nextUI))
      }
      if (nextStep === 3) {
        $(e.currentTarget).find('.step-statement').text($(e.currentTarget).find('.activity-promise').text())
        $('#dr-rai--sidebar').data('statement', $(e.currentTarget).find('.step-statement').text())
        $('.action-buttons-block .save-button').removeClass('invisible')
      } else {
        if (nextUI !== undefined) {
          $('#step-3').data('target-type', targetType)
        }
      }
    })

    $('#step-2-percent .goal-input-block input').on('blur', (e) => {
      var inputValue
      if ($(e.currentTarget).val() === '') {
        inputValue = 0
      } else {
        inputValue = parseInt($(e.currentTarget).val())
      }
      const activityPromise = $(e.currentTarget)
        .closest('.goal-input-block')
        .siblings('.activity-promise')
      activityPromise.find('.highlight')
        .text(Math.round(inputValue / 100 * $('#step-2-percent').data('denominator')))
      activityPromise.removeClass('d-none')
    })

    $('.action-buttons-block .save-button').on('click', (e) => {
      // FIXME: Handle saving a goal via POST to the database.
      // This is where we do the post call to the Rails backend and handle all
      // possibilities which may arise from saving a goal

      $.ajax({
        url: `/dr_rai/action_plans`,
        type: 'POST',
        data: {
          'dr_rai_action_plan': {
            'indicator_id': $('#dr-rai--sidebar').data('indicator-id'),
            'period': $('#dr-rai--sidebar').data('period'),
            'actions': $('.custom-actions-list').val(),
            'region_slug': $('#dr-rai--sidebar').data('region'),
            'statement': $('#dr-rai--sidebar').data('statement'),
            'target_type': $('#dr-rai--sidebar').data('target-type'),
            'target_value': $('.goal-input-block input').val(),
          }
        },
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        success: (response) => {
          window.location.reload()
        },
        error: (xhr) => {
          // Technically there should be no error case. IF an entry is entered
          // wrongly, removing the entry and redoing it costs little
        }
      });

    })

    $('.step-block .next-button, .advancer').on('click', (e) => {
      $('#dr-rai--sidebar').data('indicator-id', $(e.currentTarget).data('indicator-id'))
      $('#dr-rai--sidebar').data('target-type', $(e.currentTarget).data('target-type'))
      $(e.currentTarget)
        .closest('.step-block')
        .trigger("step-through", [
          $(e.currentTarget).data('target-ui'),
          $(e.currentTarget).data('target-type'),
          $(e.currentTarget).data('indicator-denominator'),
        ])
    })

    $('.link-button.advancer').on('click', (e) => {
      $(e.currentTarget)
        .closest(".active")
        .siblings('.inactive')
        .children('.step-statement')
        .first()
        .text($(e.currentTarget).text())
    })

    $('.cancel-button').on('click', (e) => {
      // Clear "state"
      $('#dr-rai--sidebar').removeData([
        'indicator-id',
        'period',
        'region_slug',
        'statement',
        'actions',
      ])

      // Reset UI
      toHide.forEach((el) => el.addClass('d-none'))
      toReveal.forEach((el) => el.removeClass('d-none'))
      $('.action-buttons-block .save-button').addClass('d-none')
      $('.sidepanel input').val('')
      $('.active .activity-promise').addClass('invisible')
      $('.sidepanel textarea').val('')

      // Close the offcanvas
      $('.bs-canvas-close').trigger('click')
    })

    // A poor man's state update
    $('.common-actions-list .link-button').on('click', (e) => {
      if ($('.custom-actions-list').val() === '') {
        $('.custom-actions-list').val($(e.currentTarget).text())
      } else {
        $('.custom-actions-list').val($('.custom-actions-list').val() + "\n" + $(e.currentTarget).text())
      }
    })
  });
</script>
