<div class="card mb-0">
  <div class="d-flex mb-8px">
    <div class="d-flex flex-1">
      <h3 class="mb-0px mr-8px">
        Blood sugar measurement details
      </h3>
      <%= render "definition_tooltip",
                 definitions: { "Blood sugar measurement details" => t("bs_measurement_details_copy.numerator", region_name: @region.name)} %>
    </div>
  </div>
  <p class="c-grey-dark">
    <%= t("bs_measurement_details_copy.reports_card_subtitle",
          region_name: @region.name,
          period_registered: @data.dig(:period_info, @period, :bp_control_registration_date),
          period_start: @data.dig(:period_info, @period, :bp_control_start_date),
          period_end: @data.dig(:period_info, @period, :bp_control_end_date)) %>
  </p>
  <div class="table-responsive-md">
    <table id="region-comparison-table" class="table-compact">
      <colgroup>
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
        <col>
        <col class="table-divider">
      </colgroup>
      <thead>
      <tr class="sorts" data-sort-method="thead">
        <th class="row-label sort-label sort-label-small ta-left" data-sort-default>
          <%= localized_region_type.capitalize %>
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          RBS/PPBS <200
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          RBS/PPBS
          200-299
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          RBS/PPBS
          ≥300
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          FBS <126
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          FBS 126-199
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          FBS ≥200
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          HbA1c <7.0
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          HbA1c 7.0-8.9
        </th>
        <th class="row-label sort-label sort-label-small ta-left" data-sort-method="number" colspan="2" class="sticky nowrap">
          HbA1c ≥9.0
        </th>
      </tr>
      </thead>
      <tbody>
        <tr class="row-total" data-sort-method="none">
        <td class="type-title">
          <%= @region.name %>
        </td>
        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_below_200_breakdown_rates, @period, :random) + @data.dig(:bs_below_200_breakdown_rates, @period, :post_prandial) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(
                       @data.dig(:bs_below_200_breakdown_counts, @period, :random) + @data.dig(:bs_below_200_breakdown_counts, @period, :post_prandial)
                     ) %> / <%= number_with_delimiter(@data.dig(:bs_below_200_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_below_200_breakdown_rates, @period, :random) + @data.dig(:bs_below_200_breakdown_rates, @period, :post_prandial) %>" class="bg-yellow" >
            <%= number_to_percentage(
              (@data.dig(:bs_below_200_breakdown_rates, @period, :random) + @data.dig(:bs_below_200_breakdown_rates, @period, :post_prandial)) || 0, precision: 0)
            %>
              </em>
              </td>
        <td class="ta-left">
          <%= @data.dig(:bs_below_200_breakdown_counts, @period, :random) + @data.dig(:bs_below_200_breakdown_counts, @period, :post_prandial) %>
        </td>

        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_200_to_300_breakdown_rates, @period, :random) + @data.dig(:bs_200_to_300_breakdown_rates, @period, :post_prandial) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(
                       @data.dig(:bs_200_to_300_breakdown_counts, @period, :random) + @data.dig(:bs_200_to_300_breakdown_counts, @period, :post_prandial)
                     ) %> / <%= number_with_delimiter(@data.dig(:bs_200_to_300_patients, @period)) %> patients"
        >
          <em data-rate="<%=
            @data.dig(:bs_200_to_300_breakdown_rates, @period, :random) + @data.dig(:bs_200_to_300_breakdown_rates, @period, :post_prandial)
          %>" class="bg-yellow" >
            <%= number_to_percentage(
                  (@data.dig(:bs_200_to_300_breakdown_rates, @period, :random) + @data.dig(:bs_200_to_300_breakdown_rates, @period, :post_prandial)) || 0, precision: 0
                ) %>
          </em>
        </td>
        <td class="ta-left">
          <%= number_with_delimiter(
                @data.dig(:bs_200_to_300_breakdown_counts, @period, :random) + @data.dig(:bs_200_to_300_breakdown_counts, @period, :post_prandial)
              ) %>
        </td>

        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%=
            @data.dig(:bs_over_300_breakdown_rates, @period, :random) + @data.dig(:bs_over_300_breakdown_rates, @period, :post_prandial)
          %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(
                       @data.dig(:bs_over_300_breakdown_counts, @period, :random) + @data.dig(:bs_over_300_breakdown_counts, @period, :post_prandial)
                     ) %> / <%= number_with_delimiter(@data.dig(:bs_over_300_patients, @period)) %> patients"
        >
          <em data-rate="<%=
            @data.dig(:bs_over_300_breakdown_rates, @period, :random) + @data.dig(:bs_over_300_breakdown_rates, @period, :post_prandial)
          %>" class="bg-yellow" >
            <%= number_to_percentage(
                  (@data.dig(:bs_over_300_breakdown_rates, @period, :random) + @data.dig(:bs_over_300_breakdown_rates, @period, :post_prandial)) || 0, precision: 0
                ) %>
          </em>
        </td>
        <td class="ta-left">
          <%= number_with_delimiter(
                @data.dig(:bs_over_300_breakdown_counts, @period, :random) + @data.dig(:bs_over_300_breakdown_counts, @period, :post_prandial)
              ) %>
        </td>

        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_below_200_breakdown_rates, @period, :fasting) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(@data.dig(:bs_below_200_breakdown_counts, @period, :fasting)) %> / <%= number_with_delimiter(@data.dig(:bs_below_200_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_below_200_breakdown_rates, @period, :fasting) %>" class="bg-yellow" >
            <%= number_to_percentage(@data.dig(:bs_below_200_breakdown_rates, @period, :fasting) || 0, precision: 0) %>
          </em>
        </td>
        <td class="ta-left">
          <%= @data.dig(:bs_below_200_breakdown_counts, @period, :fasting) %>
        </td>

        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_200_to_300_breakdown_rates, @period, :fasting) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(@data.dig(:bs_200_to_300_breakdown_counts, @period, :fasting)) %> / <%= number_with_delimiter(@data.dig(:bs_200_to_300_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_200_to_300_breakdown_rates, @period, :fasting) %>" class="bg-yellow" >
            <%= number_to_percentage(@data.dig(:bs_200_to_300_breakdown_rates, @period, :fasting) || 0, precision: 0) %>
          </em>
        </td>
        <td class="ta-left">
          <%= number_with_delimiter(@data.dig(:bs_200_to_300_breakdown_counts, @period, :fasting)) %>
        </td>
        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_over_300_breakdown_rates, @period, :fasting) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(@data.dig(:bs_over_300_breakdown_counts, @period, :fasting)) %> / <%= number_with_delimiter(@data.dig(:bs_over_300_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_over_300_breakdown_rates, @period, :fasting) %>" class="bg-yellow" >
            <%= number_to_percentage(@data.dig(:bs_over_300_breakdown_rates, @period, :fasting) || 0, precision: 0) %>
          </em>
        </td>
        <td class="ta-left">
          <%= number_with_delimiter(@data.dig(:bs_over_300_breakdown_counts, @period, :fasting)) %>
        </td>
        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_below_200_breakdown_rates, @period, :hba1c) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(@data.dig(:bs_below_200_breakdown_counts, @period, :hba1c)) %> / <%= number_with_delimiter(@data.dig(:bs_below_200_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_below_200_breakdown_rates, @period, :hba1c) %>" class="bg-yellow" >
            <%= number_to_percentage(@data.dig(:bs_below_200_breakdown_rates, @period, :hba1c) || 0, precision: 0) %>
          </em>
        </td>
        <td class="ta-left">
          <%= @data.dig(:bs_below_200_breakdown_counts, @period, :hba1c) %>
        </td>

        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_200_to_300_breakdown_rates, @period, :hba1c) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(@data.dig(:bs_200_to_300_breakdown_counts, @period, :hba1c)) %> / <%= number_with_delimiter(@data.dig(:bs_200_to_300_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_200_to_300_breakdown_rates, @period, :hba1c) %> " class="bg-yellow" >
            <%= number_to_percentage(@data.dig(:bs_200_to_300_breakdown_rates, @period, :hba1c) || 0, precision: 0) %>
          </em>
        </td>
        <td class="ta-left">
          <%= number_with_delimiter(@data.dig(:bs_200_to_300_breakdown_counts, @period, :hba1c)) %>
        </td>

        <td
          class="type-percent"
          data-sort-column-key="total-patients-<%= @period %>"
          data-sort="<%= @data.dig(:bs_over_300_breakdown_rates, @period, :hba1c) %>"
          data-toggle="tooltip"
          title="<%= number_with_delimiter(@data.dig(:bs_over_300_breakdown_counts, @period, :hba1c)) %> / <%= number_with_delimiter(@data.dig(:bs_over_300_patients, @period)) %> patients"
        >
          <em data-rate="<%= @data.dig(:bs_over_300_breakdown_rates, @period, :hba1c) %>"  class="bg-yellow" >
            <%= number_to_percentage(@data.dig(:bs_over_300_breakdown_rates, @period, :hba1c) || 0, precision: 0) %>
          </em>
        </td>
        <td class="ta-left">
          <%= number_with_delimiter(@data.dig(:bs_over_300_breakdown_counts, @period, :hba1c)) %>
        </td>
      </tr>
        <% data.each do |result| %>
          <% child = result[:region] %>
          <tr>
            <td class="ta-left">
              <%= link_to(reports_region_path(child, report_scope: child.region_type)) do %>
                <%= child.name %>
              <% end %>
            </td>
            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_below_200_breakdown_rates, @period, :random) + result.dig(:bs_below_200_breakdown_rates, @period, :post_prandial) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(
                           result.dig(:bs_below_200_breakdown_counts, @period, :random) + result.dig(:bs_below_200_breakdown_counts, @period, :post_prandial)
                         ) %> / <%= number_with_delimiter(result.dig(:bs_below_200_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_below_200_breakdown_rates, @period, :random) + result.dig(:bs_below_200_breakdown_rates, @period, :post_prandial) %>" >
                <%= number_to_percentage(
                      (result.dig(:bs_below_200_breakdown_rates, @period, :random) + result.dig(:bs_below_200_breakdown_rates, @period, :post_prandial)) || 0, precision: 0)
                %>
              </em>
            </td>
            <td class="ta-left">
              <%= result.dig(:bs_below_200_breakdown_counts, @period, :random) + result.dig(:bs_below_200_breakdown_counts, @period, :post_prandial) %>
            </td>

            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_200_to_300_breakdown_rates, @period, :random) + result.dig(:bs_200_to_300_breakdown_rates, @period, :post_prandial) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(
                           result.dig(:bs_200_to_300_breakdown_counts, @period, :random) + result.dig(:bs_200_to_300_breakdown_counts, @period, :post_prandial)
                         ) %> / <%= number_with_delimiter(result.dig(:bs_200_to_300_patients, @period)) %> patients"
            >
              <em data-rate="<%=
                result.dig(:bs_200_to_300_breakdown_rates, @period, :random) + result.dig(:bs_200_to_300_breakdown_rates, @period, :post_prandial)
              %>" >
                <%= number_to_percentage(
                      (result.dig(:bs_200_to_300_breakdown_rates, @period, :random) + result.dig(:bs_200_to_300_breakdown_rates, @period, :post_prandial)) || 0, precision: 0
                    ) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(
                    result.dig(:bs_200_to_300_breakdown_counts, @period, :random) + result.dig(:bs_200_to_300_breakdown_counts, @period, :post_prandial)
                  ) %>
            </td>

            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%=
                result.dig(:bs_over_300_breakdown_rates, @period, :random) + result.dig(:bs_over_300_breakdown_rates, @period, :post_prandial)
              %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(
                           result.dig(:bs_over_300_breakdown_counts, @period, :random) + result.dig(:bs_over_300_breakdown_counts, @period, :post_prandial)
                         ) %> / <%= number_with_delimiter(result.dig(:bs_over_300_patients, @period)) %> patients"
            >
              <em data-rate="<%=
                result.dig(:bs_over_300_breakdown_rates, @period, :random) + result.dig(:bs_over_300_breakdown_rates, @period, :post_prandial)
              %>" >
                <%= number_to_percentage(
                      (result.dig(:bs_over_300_breakdown_rates, @period, :random) + result.dig(:bs_over_300_breakdown_rates, @period, :post_prandial)) || 0, precision: 0
                    ) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(
                    result.dig(:bs_over_300_breakdown_counts, @period, :random) + result.dig(:bs_over_300_breakdown_counts, @period, :post_prandial)
                  ) %>
            </td>

            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_below_200_breakdown_rates, @period, :fasting) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result.dig(:bs_below_200_breakdown_counts, @period, :fasting)) %> / <%= number_with_delimiter(result.dig(:bs_below_200_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_below_200_breakdown_rates, @period, :fasting) %>" >
                <%= number_to_percentage(result.dig(:bs_below_200_breakdown_rates, @period, :fasting) || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= result.dig(:bs_below_200_breakdown_counts, @period, :fasting) %>
            </td>

            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_200_to_300_breakdown_rates, @period, :fasting) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result.dig(:bs_200_to_300_breakdown_counts, @period, :fasting)) %> / <%= number_with_delimiter(result.dig(:bs_200_to_300_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_200_to_300_breakdown_rates, @period, :fasting) %>" >
                <%= number_to_percentage(result.dig(:bs_200_to_300_breakdown_rates, @period, :fasting) || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result.dig(:bs_200_to_300_breakdown_counts, @period, :fasting)) %>
            </td>
            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_over_300_breakdown_rates, @period, :fasting) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result.dig(:bs_over_300_breakdown_counts, @period, :fasting)) %> / <%= number_with_delimiter(result.dig(:bs_over_300_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_over_300_breakdown_rates, @period, :fasting) %>" >
                <%= number_to_percentage(result.dig(:bs_over_300_breakdown_rates, @period, :fasting) || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result.dig(:bs_over_300_breakdown_counts, @period, :fasting)) %>
            </td>
            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_below_200_breakdown_rates, @period, :hba1c) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result.dig(:bs_below_200_breakdown_counts, @period, :hba1c)) %> / <%= number_with_delimiter(result.dig(:bs_below_200_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_below_200_breakdown_rates, @period, :hba1c) %>" >
                <%= number_to_percentage(result.dig(:bs_below_200_breakdown_rates, @period, :hba1c) || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= result.dig(:bs_below_200_breakdown_counts, @period, :hba1c) %>
            </td>

            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_200_to_300_breakdown_rates, @period, :hba1c) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result.dig(:bs_200_to_300_breakdown_counts, @period, :hba1c)) %> / <%= number_with_delimiter(result.dig(:bs_200_to_300_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_200_to_300_breakdown_rates, @period, :hba1c) %>" >
                <%= number_to_percentage(result.dig(:bs_200_to_300_breakdown_rates, @period, :hba1c) || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result.dig(:bs_200_to_300_breakdown_counts, @period, :hba1c)) %>
            </td>

            <td
              class="type-percent"
              data-sort-column-key="total-patients-<%= @period %>"
              data-sort="<%= result.dig(:bs_over_300_breakdown_rates, @period, :hba1c) %>"
              data-toggle="tooltip"
              title="<%= number_with_delimiter(result.dig(:bs_over_300_breakdown_counts, @period, :hba1c)) %> / <%= number_with_delimiter(result.dig(:bs_over_300_patients, @period)) %> patients"
            >
              <em data-rate="<%= result.dig(:bs_over_300_breakdown_rates, @period, :hba1c) %>" >
                <%= number_to_percentage(result.dig(:bs_over_300_breakdown_rates, @period, :hba1c) || 0, precision: 0) %>
              </em>
            </td>
            <td class="ta-left">
              <%= number_with_delimiter(result.dig(:bs_over_300_breakdown_counts, @period, :hba1c)) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
