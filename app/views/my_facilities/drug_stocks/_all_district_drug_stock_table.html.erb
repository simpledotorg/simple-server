<% grouped = grouped_district_reports(@district_reports) %>
<% first_drugs_by_category = @district_reports&.values&.first&.dig(:drugs_by_category) || {} %>
<% aggregated = aggregate_district_drug_stock(@district_reports, first_drugs_by_category) %>
<% all_totals, all_patient_days, all_patient_count = aggregated.values_at(:totals, :patient_days, :patient_count) %>

<div class="district-drug-stock-table mb-5">
  <div class="table-responsive">
    <table class="mt-4 table table-compact table-hover analytics-table">
      <colgroup>
        <col>
        <col>
        <% first_drugs_by_category.each do |drug_category, drugs| %>
          <% drugs.each_with_index do |_drug, index| %>
            <col class="<%= "table-divider" if index.zero? %>">
          <% end %>
          <% unless drug_category == "diabetes" %>
            <col>
          <% end %>
        <% end %>
        <col class="mobile">
      </colgroup>

      <thead>
        <tr>
          <th></th>
          <% first_drugs_by_category.each do |drug_category, drugs| %>
            <% colspan = drug_category == "diabetes" ? drugs.count : drugs.count.next %>
            <th colspan=<%= colspan %>><%= protocol_drug_labels[drug_category][:full] %></th>
          <% end %>
        </tr>

        <tr data-sort-method="thead" class="sorts">
          <th class="row-label sort-label sticky" data-sort-default>Districts</th>
          <th class="row-label sort-label sticky" data-sort-method="number">Patients <br/> under <br/> care</th>
          <% first_drugs_by_category.each do |drug_category, drugs| %>
            <% drugs.each do |drug| %>
              <th class="row-label sort-label row-medicine sticky"
                  data-sort-method="number"
                  data-sort-column-key="<%= drug.id %>">
                <%= drug.name %><br>
                <%= drug.dosage %>
              </th>
            <% end %>
            <% unless drug_category == "diabetes" %>
              <th class="row-label sort-label sticky"
                  data-sort-method="number"
                  data-sort-column-key="<%= "#{drug_category}_patient_days" %>">
                Patient<br>days
              </th>
            <% end %>
          <% end %>
        </tr>

        <tr class="row-total font-weight-bold warning" data-sort-method="none">
          <td class="type-title"
              data-html="true"
              data-toggle="tooltip"
              data-placement="top"
              data-trigger="hover focus click"
              data-original-title='<%= "All States: #{all_totals.values.sum} drugs, #{all_patient_count} patients" %>'>
            All
          </td>
          <td class="type-number text-center"><%= all_patient_count %></td>
          <% first_drugs_by_category.each do |drug_category, drugs| %>
            <% drugs.each do |drug| %>
              <td class="type-number text-center">
                <%= all_totals[drug.rxnorm_code].positive? ? all_totals[drug.rxnorm_code] : "0" %>
              </td>
            <% end %>
            <% unless drug_category == "diabetes" %>
              <% if all_patient_days[drug_category].positive? %>
                <td class="type-percent">
                  <em class="<%= patient_days_css_class(all_patient_days[drug_category]) %>" >
                    <%= all_patient_days[drug_category] %>
                  </em>
                </td>
              <% else %>
                <td class="type-blank"><span>&#8212;</span></td>
              <% end %>
            <% end %>
          <% end %>
        </tr>
      </thead>

      <% grouped.each do |state, districts| %>
        <% state_data = aggregate_state_totals(districts, first_drugs_by_category) %>
        <% state_totals = state_data[:totals] %>
        <% state_patient_days = state_data[:patient_days] %>
        <% state_patient_count = state_data[:patient_count] %>

        <tbody class="state-group">
          <tr class="row-total font-weight-bold warning" data-sort-method="none">
            <td class="type-title"
                data-toggle="tooltip"
                data-trigger="hover focus click"
                data-original-title='<%= "#{state}: #{state_totals.values.sum} drugs, #{state_patient_count} patients" %>'>
              <%= state %><br><span> subtotal </span>
            </td>
            <td class="type-number text-center"><%= state_patient_count %></td>
            <% first_drugs_by_category.each do |drug_category, drugs| %>
              <% drugs.each do |drug| %>
                <td class="type-number text-center">
                  <%= state_totals[drug.rxnorm_code].presence || "â€”" %>
                </td>
              <% end %>
              <% unless drug_category == "diabetes" %>
                <% if state_patient_days[drug_category].present? %>
                  <td class="type-percent">
                    <em class="<%= patient_days_css_class(state_patient_days[drug_category]) %>"><%= state_patient_days[drug_category] %></em>
                  </td>
                <% else %>
                  <td class="type-blank"><span>&#8212;</span></td>
                <% end %>
              <% end %>
            <% end %>
          </tr>

          <% districts.each do |district, data| %>
            <% report = data[:report] %>
            <tr class="type-number district-row">
              <td class="type-title"
                  data-html="true"
                  data-toggle="tooltip"
                  data-placement="top"
                  data-trigger="hover focus click"
                  data-original-title='<%= "#{district.name}: #{patient_count_for(report)} patients" %>'>
                <a href="<%= my_facilities_drug_stocks_path(facility_group: district.slug, for_end_of_month: @for_end_of_month_display) %>" >
                  <%= district.name %>
                </a>
              </td>
              <td class="type-number text-center" data-sort-value="<%= report[:district_patient_count] %>">
                <%= patient_count_for(report) %>
              </td>
              <% first_drugs_by_category.each do |drug_category, drugs| %>
                <% patient_days = report.dig(:total_patient_days, drug_category, :patient_days) %>
                <% drugs.each do |drug| %>
                  <% drug_stock = drug_stock_for(report, drug) %>
                  <% if drug_stock.present? && drug_stock > 0 %>
                    <td class="type-number text-center" data-toggle="tooltip" data-sort-column-key="<%= drug.id %>">
                      <%= drug_stock %>
                    </td>
                  <% else %>
                    <td class="type-blank"><span>&#8212;</span></td>
                  <% end %>
                <% end %>
                <% unless drug_category == "diabetes" %>
                  <% if patient_days.present? %>
                    <td class="type-percent"
                        data-html="true"
                        data-toggle="tooltip"
                        data-placement="top"
                        data-trigger="hover focus click"
                        data-template="<%= render 'wide_tooltip_template' %>"
                        data-original-title="<%= render 'drug_stocks_tooltip', report: report.dig(:total_patient_days, drug_category) %>"
                        data-sort-value="<%= patient_days %>">
                      <em class="<%= patient_days_css_class(patient_days) %>">
                        <%= patient_days %>
                      </em>
                    </td>
                  <% else %>
                    <td class="type-blank"><span>&#8212;</span></td>
                  <% end %>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>
  </div>
</div>

<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px b-2px bg-red br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&lt;30 patients days of stock</p>
</div>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px b-2px bg-orange br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&lt;60 patients days of stock</p>
</div>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px b-2px bg-yellow br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&lt;90 patients days of stock</p>
</div>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px bg-green br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&gt;90 patients days of stock</p>
</div>