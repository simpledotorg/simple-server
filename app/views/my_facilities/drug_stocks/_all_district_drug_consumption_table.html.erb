<% grouped = @district_reports.group_by { |district, _| district.state }.sort_by { |state, _| state } %>
<div class="district-drug-consumption-table mb-5">
  <div class="table-responsive">
    <table class="mt-4 table table-compact table-hover analytics-table">
      <colgroup>
        <col>
        <col>
        <% first_report_with_drugs = @district_reports.values.find { |data| data[:drugs_by_category].present? } %>
        <% drugs_by_category = first_report_with_drugs&.dig(:drugs_by_category) || {} %>

        <% if drugs_by_category.present? %>
          <% drugs_by_category.each do |_, drugs| %>
            <% (drugs || []).each_with_index do |_drug, index| %>
              <col class="<%= "table-divider" if index.zero? %>">
            <% end %>
          <% end %>
        <% end %>

        <% (drugs_by_category || {}).each_with_index do |(_drug_category, _drugs), index| %>
          <col class="<%= "table-divider" if index.zero? %>">
        <% end %>
      </colgroup>

      <thead>
        <tr>
          <th></th>
          <th></th>
          <% if drugs_by_category.present? %>
            <% drugs_by_category.each do |drug_category, drugs| %>
              <th colspan="<%= (drugs || []).count %>"><%= protocol_drug_labels[drug_category]&.dig(:full) %></th>
            <% end %>
            <th colspan="<%= drugs_by_category.count %>"><%= I18n.t('overall_in_base_dose') %></th>
          <% end %> 
        </tr>

        <tr data-sort-method="thead" class="sorts">
          <th class="row-label sort-label sticky" data-sort-default>Districts</th>
          <th class="row-label sort-label sticky" data-sort-method="number">Patients <br/> under <br/> care</th>

          <% if drugs_by_category.present? %>
            <% drugs_by_category.each do |_drug_category, drugs| %>
              <% (drugs || []).each do |drug| %>
                <th class="row-label sort-label row-medicine sticky"
                    data-sort-method="number"
                    data-sort-column-key="<%= drug.id %>">
                  <%= drug.name %><br>
                  <%= drug.dosage %>
                </th>
              <% end %>
            <% end %>

            <% drugs_by_category.each do |drug_category, _drugs| %>
              <th class="row-label sort-label sticky" data-sort-method="number" data-sort-column-key="<%= "#{drug_category}_base_doses" %>">
                <%= protocol_drug_labels[drug_category]&.dig(:short) %><br> base doses
              </th>
            <% end %>
          <% end %>
        </tr>
      </thead>

      <% aggregated = aggregate_drug_consumption(@district_reports, drugs_by_category) %>
      <% all_totals = aggregated[:totals] %>
      <% all_base_totals = aggregated[:base_totals] %>
      <% all_patient_count = aggregated[:patient_count] %>

      <tr class="row-total font-weight-bold warning" data-sort-method="none">
        <td class="type-title"
            data-html="true"
            data-toggle="tooltip"
            data-placement="top"
            data-trigger="hover focus click"
            data-original-title='<%= "All States: #{all_totals.values.sum} units, #{all_patient_count} patients" %>'>
          All
        </td>
        <td class="type-number text-center" data-sort-value="<%= all_patient_count %>">
          <%= all_patient_count.positive? ? all_patient_count : '0' %>
        </td>

        <% if drugs_by_category.present? %>
          <% drugs_by_category.each do |_, drugs| %>
            <% (drugs || []).each do |drug| %>
              <% consumed = all_totals[drug.id] %>
              <td class="<%= consumed.zero? ? 'type-blank' : 'type-number text-center' %>" data-sort-value="<%= consumed %>">
                <%= consumed.zero? ? '&#8212;'.html_safe : consumed %>
              </td>
            <% end %>
          <% end %>

          <% drugs_by_category.each do |drug_category, _drugs| %>
            <% base_total = all_base_totals[drug_category] %>
            <td class="<%= base_total.zero? ? 'type-blank' : 'type-number text-center' %>"
                data-sort-value="<%= base_total %>"
                data-sort-column-key="<%= "#{drug_category}_base_doses" %>">
              <%= base_total.zero? ? '&#8212;'.html_safe : base_total %>
            </td>
          <% end %>
        <% end %>
      </tr>

      <% grouped.each do |state, districts| %>
        <% state_totals = Hash.new(0) %>
        <% state_base_totals = Hash.new(0) %>
        <% state_patient_count = 0 %>

        <% districts.each do |_, data| %>
          <% report = data[:report] %>
          <% state_patient_count += report[:district_patient_count].to_i %>

          <% drugs_by_category.each do |drug_category, drugs| %>
            <% (drugs || []).each do |drug| %>
              <% consumed = report[:total_drug_consumption]&.dig(drug_category, drug, :consumed) %>
              <% state_totals[drug.id] += consumed.to_i if consumed.present? && consumed != "error" %>
            <% end %>
            <% base_total = report[:total_drug_consumption]&.dig(drug_category, :base_doses, :total) %>
            <% state_base_totals[drug_category] += base_total.to_i if base_total.present? && base_total != "error" %>
          <% end %>
        <% end %>

        <tbody class="state-group">
          <tr class="row-total font-weight-bold warning" data-sort-method="none">
            <td class="type-title"
                data-html="true"
                data-toggle="tooltip"
                data-placement="top"
                data-trigger="hover focus click"
                data-original-title='<%= "#{state}: #{state_totals.values.sum} units, #{state_patient_count} patients" %>'>
              <%= state %><br><span> subtotal </span>
            </td>
            <td class="type-number text-center" data-sort-value="<%= state_patient_count %>">
              <%= state_patient_count.positive? ? state_patient_count : '0' %>
            </td>

            <% drugs_by_category.each do |_, drugs| %>
              <% (drugs || []).each do |drug| %>
                <% consumed = state_totals[drug.id] %>
                <td class="<%= consumed.zero? ? 'type-blank' : 'type-number text-center' %>" data-sort-value="<%= consumed %>">
                  <%= consumed.zero? ? '&#8212;'.html_safe : consumed %>
                </td>
              <% end %>
            <% end %>

            <% drugs_by_category.each do |drug_category, _drugs| %>
              <% base_total = state_base_totals[drug_category] %>
              <td class="<%= base_total.zero? ? 'type-blank' : 'type-number text-center' %>"
                  data-sort-value="<%= base_total %>"
                  data-sort-column-key="<%= "#{drug_category}_base_doses" %>">
                <%= base_total.zero? ? '&#8212;'.html_safe : base_total %>
              </td>
            <% end %>
          </tr>

          <% districts.each do |district, data| %>
            <% report = data[:report] %>
            <tr class="type-number district-row">
              <td class="type-title"
                  data-html="true"
                  data-toggle="tooltip"
                  data-placement="top"
                  data-trigger="hover focus click"
                  data-original-title='<%= "#{district.name}: #{report[:district_patient_count]} patients" %>'>
                <a href="<%= my_facilities_drug_consumption_path(facility_group: district.slug, for_end_of_month: @for_end_of_month_display) %>">
                  <%= district.name %>
                </a>
              </td>
              <td class="type-number text-center" data-sort-value="<%= report[:district_patient_count].to_i %>">
                <%= report[:district_patient_count].present? ? report[:district_patient_count] : '<span class="type-blank">?</span>'.html_safe %>
              </td>

              <% drugs_by_category.each do |drug_category, drugs| %>
                <% (drugs || []).each do |drug| %>
                  <% consumed = report[:total_drug_consumption]&.dig(drug_category, drug, :consumed) %>
                  <% if consumed == "error" %>
                    <td class="type-blank"><span>?</span></td>
                  <% elsif consumed.nil? %>
                    <td class="type-blank"><span>&#8212;</span></td>
                  <% else %>
                    <td class="type-number text-center"
                        data-html="true"
                        data-toggle="tooltip"
                        data-placement="top"
                        data-trigger="hover focus click"
                        data-original-title="<%= render 'drug_consumption_tooltip', report: report[:total_drug_consumption][drug_category][drug] %>"
                        data-sort-value="<%= consumed %>"
                        data-sort-column-key="<%= drug&.id %>">
                      <%= consumed %>
                    </td>
                  <% end %>
                <% end %>
              <% end %>

              <% drugs_by_category.each do |drug_category, _drugs| %>
                  <% base_total = report[:total_drug_consumption]&.dig(drug_category, :base_doses, :total) %>
                  <td class="<%= base_total.nil? || base_total == 0 ? 'type-blank' : 'type-number text-center' %>"
                      data-html="true"
                      data-toggle="tooltip"
                      data-placement="top"
                      data-trigger="hover focus click"
                      data-template="<%= render 'wide_tooltip_template' %>"
                      data-original-title="<%= render 'base_doses_tooltip', report: report&.dig(:total_drug_consumption, drug_category, :base_doses) %>"
                      data-sort-value="<%= base_total.to_i %>"
                      data-sort-column-key="<%= "#{drug_category}_base_doses" %>">
                    <%= base_total.present? && base_total != "error" ? base_total : '&#8212;'.html_safe %>
                  </td>
                <% end %>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>
  </div>
</div>