<div class="district-drug-consumption-table mb-5">
  <div class="table-responsive">
    <table class="mt-4 table table-compact table-hover analytics-table">
      <colgroup>
        <col> <%# District %>
        <col> <%# Patients under care %>
        <% first_drugs_by_category = @district_reports&.values&.first&.dig(:drugs_by_category) %>
        <% if first_drugs_by_category.present? %>
          <% first_drugs_by_category.each do |drug_category, drugs| %>
            <% drugs.each_with_index do |_drug, index| %>
              <col class="<%= "table-divider" if index.zero? %>">
            <% end %>
          <% end %>
        <% end %>
      </colgroup>

      <thead>
        <%# --- First row: Facilities + categories --- %>
        <tr>
          <th colspan="2"></th>
          <% if first_drugs_by_category.present? %>
            <% first_drugs_by_category.each do |drug_category, drugs| %>
              <th colspan="<%= drugs.count %>"><%= protocol_drug_labels[drug_category]&.dig(:full) %></th>
            <% end %>
          <% end %>
        </tr>

        <%# --- Second row: column headers --- %>
        <tr data-sort-method="thead" class="sorts">
          <th class="row-label sort-label sticky" data-sort-default data-sort-column-key="district_name">District</th>
          <th class="row-label sort-label sticky" data-sort-method="number" data-sort-column-key="patients_under_care">
            Patients <br/> under <br/> care
          </th>
          <% if first_drugs_by_category.present? %>
            <% first_drugs_by_category.each do |drug_category, drugs| %>
              <% drugs.each do |drug| %>
                <th class="row-label sort-label row-medicine sticky"
                    data-sort-method="number"
                    data-sort-column-key="<%= drug&.id %>">
                  <%= drug&.name %><br>
                  <%= drug&.dosage %>
                </th>
              <% end %>
            <% end %>
          <% end %>
        </tr>

        <%# --- All States total row --- %>
        <% all_totals = Hash.new(0) %>
        <% all_patient_count = 0 %>
        <% @district_reports&.each do |_, data| %>
          <% report = data[:report] %>
          <% if first_drugs_by_category.present? %>
            <% first_drugs_by_category.each do |_, drugs| %>
              <% drugs.each do |drug| %>
                <% consumption = if params[:zone].present? || params[:size].present?
                                  report&.dig(:drug_consumption_by_facility_id)&.values&.map { |h| h&.values&.sum || 0 }&.sum || 0
                                else
                                  report&.dig(:drug_consumption)&.dig(drug&.rxnorm_code)
                                end %>
                <% all_totals[drug&.rxnorm_code] += consumption.to_i if consumption.present? && consumption != "error" %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
        <tr class="row-total font-weight-bold warning" data-sort-method="none">
          <td class="type-title"
              data-html="true"
              data-toggle="tooltip"
              data-placement="top"
              data-trigger="hover focus click"
              data-original-title='<%= "All States: #{all_totals.values.sum} units, #{all_patient_count} patients" %>'>
            All
          </td>
          <td class="type-number text-center" data-sort-value="<%= all_patient_count %>"><%= all_patient_count %></td>
          <% if first_drugs_by_category.present? %>
            <% first_drugs_by_category.each do |_, drugs| %>
              <% drugs.each do |drug| %>
                <td class="type-number text-center" data-sort-value="<%= all_totals[drug&.rxnorm_code] %>">
                  <%= all_totals[drug&.rxnorm_code].positive? ? all_totals[drug&.rxnorm_code] : "0" %>
                </td>
              <% end %>
            <% end %>
          <% end %>
        </tr>
      </thead>

      <%# --- State-wise grouping --- %>
      <% grouped = @district_reports&.group_by { |district, _| district&.state }&.sort_by { |state, _| state } || [] %>
      <% grouped.each do |state, districts| %>
        <% state_totals = Hash.new(0) %>
        <% state_patient_count = 0 %>
        <% districts.each do |_, data| %>
          <% report = data[:report] %>
          <% state_patient_count += (params[:zone].present? || params[:size].present?) ? report&.dig(:facilities_total_patient_count).to_i : report&.dig(:district_patient_count).to_i %>
          <% if first_drugs_by_category.present? %>
            <% first_drugs_by_category.each do |_, drugs| %>
              <% drugs.each do |drug| %>
                <% consumption = if params[:zone].present? || params[:size].present?
                                  report&.dig(:drug_consumption_by_facility_id)&.values&.map { |h| h&.values&.sum || 0 }&.sum || 0
                                else
                                  report&.dig(:drug_consumption)&.dig(drug&.rxnorm_code)
                                end %>
                <% state_totals[drug&.rxnorm_code] += consumption.to_i if consumption.present? && consumption != "error" %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>

        <tbody class="state-group" data-state="<%= state&.parameterize %>">
          <%# --- State subtotal row --- %>
          <tr class="row-total font-weight-bold warning state-subtotal" data-sort-method="none" data-state-name="<%= state %>">
            <td class="type-title"
                data-html="true"
                data-toggle="tooltip"
                data-placement="top"
                data-trigger="hover focus click"
                data-original-title='<%= "#{state}: #{state_totals.values.sum} units, #{state_patient_count} patients" %>'>
              <%= state %><br><span> subtotal </span>
            </td>
            <td class="type-number text-center" data-sort-value="<%= state_patient_count %>"><%= state_patient_count %></td>
            <% if first_drugs_by_category.present? %>
              <% first_drugs_by_category.each do |_, drugs| %>
                <% drugs.each do |drug| %>
                  <td class="type-number text-center" data-sort-value="<%= state_totals[drug&.rxnorm_code] %>"><%= state_totals[drug&.rxnorm_code] %></td>
                <% end %>
              <% end %>
            <% end %>
          </tr>

          <%# --- District rows --- %>
          <% districts.each do |district, data| %>
            <% report = data[:report] %>
            <tr class="type-number district-row" data-sort-parent="<%= state&.parameterize %>">
              <td class="type-title"
                  data-html="true"
                  data-toggle="tooltip"
                  data-placement="top"
                  data-trigger="hover focus click"
                  data-original-title='<%= "#{district&.name}: #{(params[:zone].present? || params[:size].present?) ? report&.dig(:facilities_total_patient_count) : report&.dig(:district_patient_count)} patients" %>'>
                <a href="<%= my_facilities_drug_consumption_path(facility_group: district&.slug, for_end_of_month: @for_end_of_month_display) %>" target="_blank">
                  <%= district&.name %>
                </a>
              </td>
              <td class="type-number text-center" data-sort-value="<%= report&.dig(:district_patient_count).to_i %>">
                <%= (params[:zone].present? || params[:size].present?) ? report&.dig(:facilities_total_patient_count) : report&.dig(:district_patient_count) %>
              </td>
              <% if first_drugs_by_category.present? %>
                <% first_drugs_by_category.each do |_, drugs| %>
                  <% drugs.each do |drug| %>
                    <% consumption = if params[:zone].present? || params[:size].present?
                                      report&.dig(:drug_consumption_by_facility_id)&.values&.map { |h| h&.values&.sum || 0 }&.sum || 0
                                    else
                                      report&.dig(:drug_consumption)&.dig(drug&.rxnorm_code)
                                    end %>
                    <% numeric_value = (consumption.present? && consumption != "error") ? consumption.to_i : 0 %>
                    <td class="type-number text-center" data-sort-value="<%= numeric_value %>">
                      <%= consumption.present? && consumption != "error" ? consumption : "0" %>
                    </td>
                  <% end %>
                <% end %>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    </table>
  </div>
</div>

<%# --- Legend --- %>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px b-2px bg-red br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&lt;30 patients days of stock</p>
</div>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px b-2px bg-orange br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&lt;60 patients days of stock</p>
</div>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px b-2px bg-yellow br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&lt;90 patients days of stock</p>
</div>
<div class="d-flex align-center">
  <em class="h-16px w-16px mr-8px bg-green br-8px"></em>
  <p class="fs-12px lh-1 c-grey-dark mt-2 mb-2">&gt;90 patients days of stock</p>
</div>