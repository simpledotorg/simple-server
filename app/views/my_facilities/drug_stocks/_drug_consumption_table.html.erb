require "rails_helper"

RSpec.describe "my_facilities/drug_stocks/_drug_consumption_table.html.erb", type: :view do
  let(:region) { double("Region", id: 1, name: "Block A") }
  let(:facility1) { double("Facility", id: 1, name: "Facility 1", region: region) }
  let(:facility2) { double("Facility", id: 2, name: "Facility 2", region: region) }
  let(:facilities) { [facility1, facility2] }

  let(:drug) { double("Drug", id: 101, name: "Amlodipine", dosage: "5mg") }
  let(:drug_category) { :hypertension }

  let(:facility1_report) do
    {
      drug_category => {drug => {consumed: 5}, :base_doses => {total: 5}}
    }
  end

  let(:facility2_report) do
    {
      drug_category => {drug => {consumed: 7}, :base_doses => {total: 7}}
    }
  end

  let(:report) do
    {
      total_patient_count: 120,
      district_patient_count: 120,
      patient_count: 120,
      facilities_total_patient_count: 120,
      patient_count_by_block_id: {region.id => 120},
      patient_count_by_facility_id: {1 => 50, 2 => 70},
      total_drug_consumption: {
        drug_category => {drug => {consumed: 12}, :base_doses => {total: 12}}
      },
      district_drug_consumption: {
        drug_category => {drug => {consumed: 12}, :base_doses => {total: 12}}
      },
      drug_consumption_by_block_id: {
        region.id => {
          drug_category => {drug => {consumed: 12}, :base_doses => {total: 12}}
        }
      },
      facilities_total_drug_consumption: {
        drug_category => {drug => {consumed: 12}, :base_doses => {total: 12}}
      },
      drug_consumption_by_facility_id: {
        1 => facility1_report,
        2 => facility2_report
      }
    }
  end

  before do
    assign(:report, report)
    assign(:facilities, facilities)
    assign(:blocks, [region])
    assign(:district_region, region)
    assign(:drugs_by_category, {drug_category => [drug]})

    allow(view).to receive(:can_view_all_districts_nav?).and_return(true)
    allow(view).to receive(:protocol_drug_labels).and_return({
      hypertension: {full: "Hypertension drugs", short: "HTN"}
    })

    render partial: "my_facilities/drug_stocks/drug_consumption_table",
           locals: {report: report, facilities: facilities}
  end

  it "renders the total patients in 'All' row" do
    expect(rendered).to match(/All facilities: 120 patients/)
    expect(rendered).to match(/120<\/td>/)
  end

  it "renders drug consumption values" do
    expect(rendered).to match(/12<\/td>/) 
    expect(rendered).to match(/HTN<br> base doses/)
  end

  it "renders facility rows" do
    expect(rendered).to match(/Facility 1/)
    expect(rendered).to match(/Facility 2/)
    expect(rendered).to match(/5<\/td>/) 
    expect(rendered).to match(/7<\/td>/) 
  end
end
